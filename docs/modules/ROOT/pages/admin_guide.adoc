= Administrator Guide
:description: Comprehensive documentation or administrators of ThreatX products
:keywords: documentation, security, api, application, vulnerability, prevention, protection, ThreatX
:page-category: user-guides
:product-name: ThreatX Dashboard
:page-product-name:  {product-name}
:page-origin-type: git
:icons: font
:source-highlighter: highlight.js
:imagesdir: ../images
:page-pdf-filename: user-guides.pdf


image:deployment-guides.svg[title="Deployment Guides"] The {organization}‚Ñ¢ Managed API and Application Protection platform is a Protection as a Service offering that protects your APIs and applications from the full breadth of Layer 7 security threats, including traditional OWASP attacks, bots, malicious automation, DDoS, and API-specific attacks.

This guide focuses on the administrator tasks.


[[administator-overview,Administrator Overview]]
== Administrator overview

The {organization} platform has configuration, user, firewall, and other settings that can be managed by the {organization} SOC, your local administrator, or a combination of both. Your {organization} account must have write access to perform these tasks.


=== Interfaces

The administrative settings can be accessed from the {organization} user interface or API command line interface.

The {organization} user interface presents the data the platform collects into various pages and tables. The {organization} navigation bar has a *Settings* menu, under which you can access the pages discussed in this guide. You can log in to the {organization} user interface at https://x.threatx.io/.

image:common/Attack-Dashboard.jpg[Attack Dashboard,width=1024,height=666]

The {organization} platform uses a RESTful API and supports a full set of application capabilities that can be used ad-hoc, in scripts, and in automation tool sets. Common uses include creating and managing user accounts, provisioning new sites to be protected, and managing certificates. To access the {organization} API, you need an API key to help you authenticate and create a session token, as described in link:#generating-and-revoking-api-keys[Generating and revoking API keys]. To use the {organization} API, you need to know the API token and the tenant name. For details about the API endpoints and commands, see the https://support.threatx.com/hc/en-us/articles/360000661851-API-Reference-Guide-1-34-0[API Reference Guide] (requires a {organization} account to access).


==== Firewall settings

When adding sites or testing DNS cut-overs, you might need to reference the following {organization} sensor IP addresses and the CNAME for your tenant. These were set when the sensors were deployed.

{organization} Service IP addresses:: IP addresses that represent the {organization} sensors. These IP addresses must be whitelisted in your environment to ensure traffic can reach your application.
Sensor DNS Targets:: CNAME records you can use to ensure HTTP and HTTPS traffic reaches your sensors. The CNAME provided for your tenant is all you need for all your sites. The {organization} sensor is Server Name Indication (SNI) aware and refers to the hostname provided in each request when visualizing and routing traffic. Request traffic for each of your sites is routed to the backend you defined for that site on the site‚Äôs details page.

In the {organization} user interface, navigate to‚ÄØmenu:Settings[IWAF] and select btn:[Firewall]. If you have access to the {organization} API, you can use the {organization} `/tx_api/v1/services` endpoint, *list* command.

NOTE: The {organization} /tx_api/v1/services endpoint *list* command returns the service IP addresses, but not the CNAME records.


==== Tenants and channels

Tenants are organizational units. Administrator user accounts are provisioned within these tenants. Once provisioned, users can view protected sites, attack heuristics, real-time data, and other configuration information.

Alternatively, you can have your {organization} platform organized by channels, where a channel can contain multiple tenants. If you have channels, you can administer all users and sites within the tenants and add tenants as needed.


==== Optional features

The {organization} platform has the following optional features that are available depending on your configuration.

* Risk-based blocking
* Edge caching
* Sensitive data
* Site certificate management

TIP: For more information about these features, see the xref:overview_guide.adoc[{organization} Managed API and Application Protection Platform Overview Guide]. If you require any feature that is not enabled, contact the {organization} SOC.

'''

=== Managing listed IP addresses

The IP lists are used to block, deny, and allow IP addresses. An IP address in the block list is there temporarily. An IP address in the blacklist or whitelist is there permanently until it is manually removed. As an administrator, you might need to manually add or remove an IP address or CIDR range from the list.

In the {organization} user interface, navigate to‚ÄØmenu:Settings[IWAF]. The IWAF Settings page has tabs for *Blocked IP addresses*, *Blacklisted IP addresses*,and *Whitelisted IP addresses*. If you have access to the {organization} API, you can use the {organization} `/tx_api/v1/lists` endpoint to manage the lists.

The lists are often managed by your analysts and, therefore, the procedures to manage the lists are provided in the xref:analyst_guide.adoc[{organization} Managed API and Application Protection Platform Analyst Guide]. **


[[managing-risk-based-blocking]]
=== Managing Risk-Based Blocking

NOTE: To configure the following settings, the *{organization} Risk-Based Blocking* feature must be enabled.

In the {organization} user interface, navigate to‚ÄØmenu:Settings[IWAF] and select btn:[Firewall]. If you have access to the {organization} API, you can use the {organization} `/tx_api/v1/customers` endpoint.

.Risk-Based Blocking Settings
[cols="30m,70",options="header",]
|===
|Setting | Description
|Risk-Based Blocking Timeout
|Length of time a threat is blocked. Applies only to those threats that are blocked automatically. Default is 30 minutes.

|Risk-Based Blocking Threshold
|Risk Level score. Any threat that meets or exceeds the score is blocked automatically. Default is 70.

|Block Embargoed Countries
|When checked, any traffic from a country that is on the USA embargo list is blocked automatically. Countries include Iran, North Korea, Syria, Sudan, Cuba, and Venezuela. Contact {organization} SOC if you need rules to block countries not on the list.

|Block TOR Exit nodes
|When checked, all incoming traffic from a TOR Exit node is not allowed. Tor Exit Nodes are the gateways where encrypted Tor traffic hits the Internet.
|===

'''

[[managing-sites-and-groups,Managing Sites and Groups]]
=== Managing sites and site groups

A site is a web property serving API responses intended for consumption by an application. Your environment might have many sites, where some sites might not be under {organization} protection.

You can add, edit, or remove sites with the {organization} user interface or {organization} API.

[[site-settings]]
==== Site settings

The {organization} sensor operates as a reverse proxy and is designed to monitor and act on incoming HTTP(s) request traffic to prevent attacks and unwanted activity from reaching your web application and API servers. The backend you define for each site can be a single CNAME or a list of IP addresses ‚Äì wherever traffic can be properly routed to reach your origin servers.

TIP: If using the {organization} user interface, navigate to menu:Settings[Site]. If you have access to the {organization} API, you can use the {organization} `/tx_api/v1/sites` endpoint.

Some of the settings are on the *Sites* page as column headers.

To add a site, click the btn:[Add Site]. To edit a site, click btn:[Edit Site] button for the specific site. In either case, the configuration settings open in the *Site Details* page.


.Listener Configuration
[width="100%",cols="30,70",options="header",]
|===
|Setting|Description

|Host Name
|Domain name protected by the sensor (for example, www.example.com). It must be unique across all configured sites and cannot contain uppercase letters.‚ÄØOnce created, the configured hostname cannot be changed.

|SSL/TLS Enabled
|Allows HTTPS connections to the hostname. Use this setting to provide your own site certificate (in PEM format). The setting does not need to be enabled if using {organization} managed certificates with Let‚Äôs Encrypt. For more information, see the _Site certificates_ section.

|SSL/TLS Terminate Only
|If set, SSL/TLS connection is terminated at the sensor and requests are sent through a proxy to the backend using HTTP.

|Redirect HTTP traffic to HTTPS
|If enabled, requests made to the hostname using HTTP receive a 301 response code and are redirected to the same hostname using HTTPS instead.

|HTTP2 Enabled
|Allows HTTP Version 2 traffic.

|Wildcard Subdomains Enabled
|For example, if enabled for site with ‚Äúexample.com‚Äù hostname, site configuration also applies to all requests sent to ‚Äúsubdomain.example.com‚Äù.

|===

.Backend Configuration
[width="100%",cols="30,70",options="header",]
|===
|Setting |Description

|Origin
|Location where traffic can be properly routed to reach your origin server, also called a backend. You can specify a single hostname or CNAME, or a comma-separated list of IP addresses. If you are forwarding traffic to a load balancer, supply the FQDN or IP addresses of your load balancer. The sensor forwards all benign and unblocked traffic to that load balancer.

|HTTP Backend Port
|Port number of the origin server or load balancer accepting HTTP traffic.

|HTTPS Backend Port
|Port number of the origin server or load balancer accepting HTTPS traffic.
|===

.Blocking Modes
[width="100%",cols="30,70",options="header",]
|===
| Setting | Description

|Risk-Based Blocking
|If set, any entity with accumulated risk above the risk-based blocking threshold is blocked. The threshold settings are described in <<managing-risk-based-blocking,Managing Risk-Based Blocking>>.

|Request Blocking
|If set, individual requests that are obvious hostile attacks, as determined by the {organization} rules, aure blocked.

|Manual Action Blocking
|If set, users can manually add IP addresses to the blocked list and blacklist.

|===

.Caching Configuration
[width="100%",cols="30,70",options="header",]
|===
| Setting | Description

|Static Caching Enabled
|Enables static caching. See <<managing-caching,Managing Caching>> for details.

|Dynamic Caching Enabled
|Enables dynamic caching. See link:#managing-caching[Managing caching] for details.
|===

.Proxy Configuration
[width="100%",cols="30,70",options="header",]
|===
|Setting | Description

|Maximum Request Body Size
|Maximum client request body in MB as read from Content-Length header. Accepts values from 1 to 1,000,000 (1MB to 1TB). Default is 1MB.

|Proxy Read Timeout
|Timeout in seconds for reading a response from the backend. Accepts values from 1 to 3,600 (1 second to 1 hour). Default is 90 seconds.

|Proxy Send Timeout
|Timeout in seconds for sending a request to the backend. Accepts values from 1 to 3,600 (1 second to 1 hour). Default is 30 seconds.

|Set Real IP From Enabled
|When checked, client requests override the IP address (as recognized by sensors).  *Header Name*. Provides the value for the IP override; for example, ‚ÄúX-Real-IP‚Äù or ‚ÄúX-Forwarded-For‚Äù. Letters, numbers, hyphens, and underscores only. *Trusted Sources*. IP addresses of the trusted sources.

|Custom Response Headers Enabled
|Inserts one or more custom headers into responses, including common security headers such as Content-Security-Policy. Each custom header must have a name and value.

|===

.Access Configuration
[width="100%",cols="30,70",options="header",]
|===
| Setting | Description

|Site Groups
|You can assign the site to an existing site group, which allows you to limit which users can access the site configuration and its associated data.

|===

==== Adding a site

NOTE: Adding a site can impact the cost of the {organization} platform. For information, contact the {organization} SOC.

Complete the checklist below to add  a site for protection within the {organization} platform.


.Site On-boarding Checklist
[cols="10,60b,30",options="header",]
|===
| Y / N | Question | Notes

|
|Does the application process requests with well-formed SQL queries?
|This is common in Help Desk and Bug-Tracking software.

|
|Does the application process requests with well-formed HTML?
|This is common for Content Management Systems.

|
|Does the application require Two-Way SSL/TLS for client authentication?
| -

|
|Does the application use WebSockets?
| -

|
|Does the application require a specific TLS version or cipher suite restriction?
|Default is TLS 1.2 and 1.3.

|
|Are any custom rules required to enforce a unique security or business requirement?
|For example, block traffic from foreign countries.

|
|Is there ANY additional infrastructure that exists outside of this flow: *Client ‚Üí {organization} sensor ‚Üí Application*
|Examples include a load balancer or proxy in use between the client and {organization} sensor.

|
|Is there any upstream architecture, such as a firewall or CDN, where you need to whitelist your {organization} service IP addresses?
| -
|===

IMPORTANT: If you answer *yes* to any of the preceding questions, *contact {organization} Support at link:mailto:support@threatx.com[] with details so we can assist.*


. Use the {organization} user interface or API to add the site and enter the configuration settings, as described in the _Site settings_ section.
. If you are not using the Let‚Äôs Encrypt option for client-facing certificates, provide the SSL/TLS Certificat `.pem` file in the *SSL/TLS Enabled* site setting.
. Once the site is available in the {organization} user interface, cut-over DNS to direct traffic to the CNAME provided for your tenant through your DNS provider. The CNAME records are provided in the IWAF settings, as described in the _Firewall settings_ section under link:#administator-overview[Administrator Overview]. This can be done at your own pace.

If you are adding multiple sites, you can add the additional sites first then cut-over DNS after.

If your DNS provider does not allow you to point to a root domain directly to a CNAME, contact {organization} SOC to provide the sensor ingress IP addresses to use as A records.

Once your site is configured and traffic is flowing through your sensor, you should see traffic populated in the dashboard. If you do not see any traffic, contact the {organization} SOC.


==== Site certificates

You have two options. You can use Let‚Äôs Encrypt or upload your own certificate.

The {organization} platform can manage the SSL/TLS/TLS certificates presented to your site‚Äôs visitors with Let‚Äôs Encrypt. The Let‚Äôs Encrypt integration allows you to offload the overhead and management commonly associated with managing SSL/TLS/TLS certificates while ensuring that an expired certificate is never presented to your site‚Äôs visitors. For more information, contact the {organization} SOC.

===== Use a Custom Certificate

To upload your own certificate using the {organization} user interface, perform the following:

. Navigate to menu:Settings[Sites].
. If updating a certificate for an existing site, locate the site. You can use the search icon in the *Hostname* column to locate a site. Then click  btn:[Edit Site].
. In the configuration page, enable *SSL/TLS Enabled*.
. Click menu:Settings[Edit SSL/TLS credentials]
. Paste your** Site Certificate**, *Intermediate Certificate*, and your *Private Key*, in *PEM* format and in that order.
. Click btn:[Save] at the bottom of the page.

If adding a site, enter your certificate using steps 3 through 6.

To ensure the correct certificate is being presented, the {organization} platform validates the following:

* Correct site or wildcard domain is listed as the Common Name or in the SAN attribute within the certificate.
* Current date is within the `notBefore` and `notAfter` fields.
* Private key provided is the same key that was used to sign the certificate.
* Formatting of the uploaded certificate chain is in the proper PEM format, without any headers present or any other characters that should not exist.

====== Troubleshooting

* *If any one of these criteria are not met*, you will receive an error describing the issue and the old certificate continues to be utilized.
* *If you are certain* that you have the correct certificate and key pair for the site and the certificate has not expired, and yet are still receiving an error, contact the {organization} SOC.
* *Optionally*, you can ask a third-party test group, such as https://www.ssllabs.com/ssltest/index.html[Qualys SSL/TLS Lab], to test and validate your certificate.


==== Site groups

[horizontal]
Web UI:: menu::Settings[Site Groups]
ThreatX API:: `/tx_api/v1/sitegroups`

You can create a site group then assign sites to a single group, which allows you to limit which users can access the site configuration and its associated data.

When creating a group, give it a name, list of sites to include in the group, and list of users that can access the sites in the group.

'''

=== Managing sensors

[horizontal]
Web UI:: menu::Settings[Sensors]
API:: `/tx_api/v1/sensor`

Sensors are managed by your local administrator or the {organization} SOC depending on if you self-host or are hosted within the {organization} cloud, respectively.

You can view the on-premises deployed sensors and their status from the {organization} user interface, menu:Settings[Sensors].
The btn:[Sensor Keys] tab lists the keys used with the sensors.
You add a key only when deploying a sensor and delete a key when the associated sensor is no longer in use.

The sensor IP addresses are available in the {organization} user interface, as described in the _Firewall settings_ section under link:#administator-overview[Administrator Overview].
These addresses must be added to the whitelist in your environment to ensure traffic can reach your application.

If the {organization} SOC hosts your sensors, you might notice the number of sensors fluctuate, or that an individual sensor‚Äôs uptime has changed.
This is because sensors are designed to be added, removed, upgraded, and replaced as needed to ensure optimal site availability and protection.
For the latest information, see our link:https://support.threatx.com/hc/en-us/sections/360008495931-Release-Notes[release notes].

If you are contemplating deploying new sites, new tech stacks, or new architecture, contact the {organization} SOC.

For more information about deploying sensors, see the Deployment guides in the navigation bar to the left.

'''

=== Configuring notifications

There are two types of notifications:

* Analytical events
* Maintenance and system status events

TIP: For information about receiving logs, see <<receiving-event-logs,Receiving event logs>>.

==== Analytical events

[horizontal]
Web UI:: menu:Settings[Notifications]
API:: `/tx_api/v1/subscriptions`

You can configure users to receive notifications on various events relating to threats, rule matches, changes to the IP allow, deny, and block lists. Notifications are typically sent by email, but you can configure a webhook notification to another app, such as Slack.

You create notifications in the {organization} user interface by navigating to menu:Settings[Notifications]. You can add a notification or edit an existing notification.

.Notification Settings
****
Name:: A unique name to identify this notification. It may only contain the following characters:
* Lowercase letters
* Hyphens
* Numbers
Enabled:: Notifications are sent to the specified target as configured.
Event Subject Area:: You can send all events or limit the notification to specific types of events:
* All Event Subjects
* Entity-related Events
* Rule-related Events
* WAF List _(Blacklist, Blocklist, Whitelist)_
* Entry-related Events
Event Incident:: If you specify a type of event in the _Event Subject Area_, you can further limit the type of event. However, no other selection is available if you choose menu:Event Subject Area[All Event Subjects] .
Event Source:: You can limit notifications to alerts from a specific {organization} system component.
* All Event Sources
* Automatic, risk engine-initiated Events
* Manual, API-initiated Events
Limit By Site:: You can limit notifications to alerts for events that affect one of a list of sites. This is only available when you select one of the following two options:
* menu:Event Subject Area[All Event Subjects]
* menu:Event Subject Area[Entity-related Events].
Limit By WAF List Type:: |You can limit notifications to events for one or more IP lists. Only available when you select menu:Event Subject Area[WAF List > _Blacklist, Blocklist, Whitelist_]
Notification Targets: Method::
* Email
* Webhooks

NOTE: You will need to configure the app to receive the notifications.For example, you can send notifications to Slack as described in their link:https://slack.com/help/articles/115005265063-Incoming-webhooks-for-Slack[Incoming Webhooks] article.
****

==== {organization} maintenance and system status

You can view and subscribe to notifications for scheduled maintenance windows and any issues that might impact your {organization} services at https://status.threatx.com/[{organization} Status].

'''

[#receiving-event-logs]
=== Receiving event logs

The {organization} Log Emitter exports event logs from the {organization} platform to your log receiver and SIEM.You can use the logs in your investigations and to trigger events in your chosen log management solution.

==== Features

The Log Emitter forwards full details for all block, match, and audit events.

The logs are pushed are in JSON lines format over a TCP connection that is encrypted, and optionally authenticated, over TLS.If the Log Emitter subscription becomes suspended, the Log Emitter service queues your logs for delivery upon successful re-connection, and periodically attempts to re-establish a connection.

In case a Log Emitter subscription becomes suspended, the Log Emitter service queues your logs for delivery upon successful re-connection, and periodically (every half hour) attempts to re-establish a connection.

Once the Log Emitter re-establishes a connection for a previously suspended subscription, all queued log events are sent to the configured receiver. If the Log Emitter subscription cannot be resumed after several retries, this might indicate a configuration error or log receiver error.


==== Configuring a Log Emitter

To receive logs, you create an instance of the Log Emitter and then encrypt the connection between the Log Emitter and your receiver.

[IMPORTANT]
.Prerequisites for Log Emitter
****
- [ ] You must whitelist the following IP address ranges:
** `169.44.76.160/28`
** `169.61.156.0/28`
** `158.85.41.64/27`
- [ ] Verify that your log receiver or SIEM can parse *JSON* lines
- [ ] *Allow* inbound connections your log receiver's *listening port* if it is behind a firewall
- [ ] Validate that your log receiver‚Äôs hostname resolves to a *public* IP address.
****

[IMPORTANT]
--
A certificate is needed to encrypt the connection between the {organization} Log Emitter service and your log receiver. You must generate a self-signed or CA signed certificate *for the hostname where the log receiver receives logs* in one of two ways:

* A *<<simple-configuration,Simple configuration>>* that sets up an encrypted TCP connection without authentication.
* An *<<advanced-configuration,Advanced configuration>>* adds mutual server and client certificate authentication to your configuration
--

[[simple-configuration]]
===== Simple configuration

.Generate a new certificate
[,console]
----
$ openssl req \
  -x509 \
  -days 365 \
  -nodes \
  -newkey rsa:4096 \
  -keyout logreceiver.key \
  -out logreceiver.crt
----

Use the `logreceiver.key` and `logreceiver.crt` files on your log receiver.

NOTE: Be sure to configure your on-premises log receiver to accept TCP connections with TLS encryption.

[[advanced-configuration]]
===== Advanced configuration

You can further secure the TCP encrypted connection between the {organization} Log Emitter and your log receiver by adding *mutual server and client certificate authentication*:

. Use the Certificate Authority of your choice to create an SSL/TLS certificate and private key for the {organization} Log Emitter.
. Create a valid server certificate and key in PEM format to install on the on-premises log receiver. The the `CN` of the server certificate *must match* the public domain name of the log receiver.
. Configure your on-premises log receiver to accept TCP connections with TLS encryption and client certificate authentication.


==== Adding a Log Emitter

--
[horizontal]
Web UI:: menu:Settings[Log Emitter] then click btn:[Add Log Emitter]
ThreatX API:: `/tx_api/v1/subscriptions`
--

Configure the settings as described in the following table. Click *Save* when done.

.Log Emitter Settings
[cols="30,20,50",options="header",]
|===
|Setting | Value | Description

| Name
| Text input
| Unique name to identify the Log Emitter.

| Hostname
| Text input
| Host name of your log receiver.

| Port
| Text input
| Port number that your log receiver listens on

| Send Client SSL/TLS Credentials to Log Receiver
| Check box
| Check to upload your SSL/TLS certificate and key

| Verify Log Receiver SSL/TLS Certificate
| Check box
| When checked, the Log Emitter verifies the SSL/TLS certificate provided by the log receiver before sending log data.

| Enabled
| Check box
| Start sending logs to your log receiver.
|===

==== Description of logs

===== BlockEvent Log Type

The *BlockEvent* log type provides full details on requests that were blocked by the {organization} sensor.

.BlockEvent Message Example
[source,json]
----
include::example$block-event-log-type-message-example.json[]
----

.BlockEvent Type Properties
[width="100%",cols="25m,75",options="header",]
|===
| Name | Details

|message
|Complete target path of the request, including hostname and URI.

|msg_type
|Request was blocked at the individual request level or due to the entity being blocked at the Risk level.

|timestamp
|UTC timestamp of the request

|user_agent
|UserAgent presented by the entity making the request

|ip
|IP address presented by the entity making the request

|dst_host
|Target hostname of the request

|uri
|Target path of the request

|args
|Arguments (if any) provided in the request in  `www-url-encoded`  form

|request_id
|Unique identifier assigned to each request by the {organization} platform

|random_id
|Additional unique identifier assigned to an entity by the {organization} platform. _See the *link:#footnote-1[note]*._

|tls_fingerprint
|TLS fingerprint (if any) associated with the entity making the request

|js_fingerprint
|Additional Unique identifier assigned to an entity by the {organization} platform. _See the *link:#footnote-1[note]*._

|===


===== MatchEvent Log Type

The *MatchEvent* log type provides full details on requests that matched custom or common rule definitions when examined by the sensor.


.MatchEvent Message Example
[source,json]
----
include::example$match-event-log-type-message-example.json[]
----

.MatchEvent Type Properties
[width="100%",cols="30m,70",options="header",]
|===
|Field | Details

|message
|Complete target path of the request, including hostname and URI.

|msg_type
|`[MatchEvent]` Request matched a custom or common rule.

|timestamp
|UTC timestamp of the request

|request_id
|Unique identifier assigned to each request by the {organization} platform.

|user_agent
|UserAgent header value presented by the Entity making the request.

|list<matches>
a|Values following this field provide specific information about why the rule that the request‚Äôs behavior matched:

* `description` - Description or name of the matched rule.
* `classification` - Industry-defined classification of the attack described in the rule.
* `state` - Industry-defined goal of the attack described in the rule.
* `contrib_score` - Reserved for {organization} internal use.
* `risk` - Amount of risk that the matched rule contributes to the requesting entity‚Äôs risk score.
* `blocking` - Rule blocked a request `[True]` or allowed the request `[False]`.
* `beta` - Reserved for {organization} internal use.

|ip
|IP address presented by the entity making the request.

|dst_host
|Target hostname of the request.

|uri
|Target path of the request.

|args
|Arguments (if any) provided in the request in `www-url-encoded` form.

|status_code
|Status code that the request received from the upstream server.

|ssl
|Request was transmitted over an HTTPS connection `[True]` or an HTTP connection `[False]`.

|request_method
|Request method type  `[GET]` or `[POST]`

|content_type
|MIME content type/subtype (if any) presented in the request.

|response_length
|Length in bytes (if any) that the request received from the upstream server.

|upstream_response_time
|Length of time in milliseconds (if any) that it took the upstream server to respond to the request.

|postblock_event
|Request was submitted after a risk-based block was applied to the entity `[True]`.

|random_id
|Additional Unique identifier assigned to an entity by the {organization} platform.  _See the *link:#footnote-1[note]*._

|tls_fingerprint
|TLS fingerprint (if any) associated with the entity making the request.

|cookie
|Additional Unique identifier assigned to an entity by the {organization} platform.  _See the *link:#footnote-1[note]*._

|js_fingerprint
|Additional Unique identifier assigned to an entity by the {organization} platform.

|created
|Timestamp of the request

|===

[NOTE,id="footnote-1"]
Returns a null value except when logging an interrogation event. For information on interrogation, contact the {organization} SOC.


==== Troubleshooting the Log Emitter

The following procedures describe basic checks that you can perform while troubleshooting your Log Emitter configuration.

===== Send test logs

Send a test log to verify that the server and client certificates are correctly generated and installed by running the following `openssl` command.

TIP: If you do not see *DONE* at the end, there is an issue with network connectivity or with the server or client certificates.

.Self-signed certificates
[,console]
----
$ echo '{"message":"test1"}' | openssl s_client \
    -servername <logreceiver.yourdomain.com>    \
    -connect <logreceiver.yourdomain.com:12345>
----


.Mutual certificate authentication
[,console]
----
$ echo '{"message":"test1"}' | openssl s_client \
    -servername <logreceiver.yourdomain.com>    \
    -connect <logreceiver.yourdomain.com:12345> \
    -cert logemitterclient.crt                  \
    -key logemitterclient.key
----

IMPORTANT: Your log receiver must be able to receive TCP data at the hostname provided to the Log Emitter. *This requires a publicly resolvable hostname.*


===== Verify incoming TCP data

Use `tcpdump` to verify that the log receiver is receiving TCP traffic on the correct port.


[,console]
----
$ `tcpdump` port 12345
----

TIP: Even if you see traffic via `tcpdump`, you still need to ensure that any host-based firewall, such as `iptables`, is configured to allow the incoming traffic.

===== Dump incoming logs to a file (Logstash)

In Logstash, you can create a file output so you can quickly see if it is receiving the logs from the Log Emitter.
Add the following fragment to your Logstash configuration file and restart Logstash.

.logstash-fragment.json
----
output {
    file {
        path => "/tmp/threatx-raw.log"
    }
}
----


===== Handshake failed error

If you use a *self-signed certificate* and you receive this error message:

[,console]
----
the handshake failed: error 1416F086: SSL/TLS Routines:
tls_process_server_certificate:certificate verify
failed:../ssl/statem/statem...cint.c:1915:: self signed certificate
----

The Log Emitter *Send Client SSL/TLS Credentials to Log Receiver* option might be enabled.
When this option is enabled, the Log Emitter uses the provided SSL/TLS credentials to authenticate itself to the log receiver, which will of course fail when using a self-signed certificate.

Resolve the issue by deselecting the *Send Client SSL/TLS Credentials to Log Receiver*. Then, click btn:[Restart Log Emitter].

'''

=== Accessing the audit log

[horizontal]
Dashboard:: menu:Settings[Audit Log]
API Endpoint:: `/tx_api/v1/logs` (command: `audit_events` )

The {organization} audit feature logs events, such as updating users, updating sites, and adding IP addresses to whitelists and blocked lists. The audit log lists all events by category and actions. As opposed to the Log Emitter, the audit log focuses mostly on user actions.

TIP: The Log Emitter also exports the audit logs.

'''

=== Managing user accounts

[horizontal]
Dashboard:: menu:Settings[Users]
API Endpoint:: `/tx_api/v1/users`


.User Account Settings
[cols="20m,80",options="header",]
|===
|Field |Description

|Email
|User‚Äôs email address, which is also the username used to log in. It cannot be changed once saved.

|Password Reset
|Available only when editing a user account. Click btn:[Send] to send a password reset link.

|First Name
|The user‚Äôs given name

|Last Name
|The user‚Äôs surname.

|Active
|When selected, the user is active and can log in. When *not selected*, the account remains valid, but the user *cannot log in*. ‚ö†Ô∏è

|Read-Only
|When *not selected*, the user has *full write access*. Otherwise, they can make no modifications. ‚ö†Ô∏è

|Tenant Admin
|When *selected*, the user has *administration permissions* to manage users and sites. ‚ö†Ô∏è

|Channel Admin
|When *selected*, the user has administrator access to the main channel _and_ *all of its tenants*. ‚ö†Ô∏è(Requires _Channel Environment architecture)._

|Site Groups
|Assigns the user to one or more user groups, where the user can access those sites only. If *none are selected*, the user can *access all sites*. ‚ö†Ô∏è
|===

'''

[[generating-and-revoking-api-keys]]
=== Generating and revoking API keys

TIP: If using the {organization} API to access the {organization} platform, you need first need to use an *API key* with the `login` command to receive a *session token*, after which you will be allowed to execute other commands.

To *generate* an API key:

. Navigate to menu:Settings[API Keys]
. Click btn:[Add API Key] in the top right corner
. Complete the necessary fields
. Click btn:[Save]
. Store your new key in a safe place! üóùÔ∏è

To *revoke* an API key:

. Navigate to menu:Settings[API Keys]
. Click btn:[Edit API Key] next to the API key you want to  revoke
. Click btn:[Revoke]
. Click btn:[Revoke] a second time in the confirmation pop-up.

'''

=== Generating and revoking sensor API keys

If you deploy sensors in your environment, you are asked to provide a Sensor API key. The sensor uses the key to authenticate to the {organization} platform.

NOTE: The _Sensor API key_ is a *not* the same as the _API key_ mentioned above.

To generate a Sensor API key:

. Navigate to menu:Settings[Sensors > Sensor Keys]
. Click btn:[Add Sensor Key]
. Store the key securely until you need to deploy a sensor üóùÔ∏è
.. If at any point you no longer require a sensor key, simply delete it.

'''

[[managing-caching]]
=== Managing caching

*Edge Caching* is available if you want to take advantage of the performance and speed improvements, but do not have a caching solution of your own in place.


[IMPORTANT]
.üåü Edge Caching Benefits
****
* Faster page load times for end-users
* Lower latency
* Increased load capacity and reduced application server load
* Better ratings from search engines such as Google
****

By default, {organization} Edge Caching follows `Cache-Control` headers defined by the origin servers.

The {organization} platform does *not* cache for the following response scenarios:

* `Cache-Control` is set to `Private`, `No-Cache`, or `No-Store`
* Response headers include `Set-Cookie`
* We are responding to `POST` requests

The {organization} platform offers two types of Edge Caching: *static* and *dynamic*.

Caching can be enabled for a configured site as described in <<site-settings,Managing Site Settings>>.


==== Static caching

Static caching is configured to cache static elements such as images, CSS & JavaScript.
Static caching does not store HTML pages and as a result does not enhance performance if the origin server becomes unresponsive.


.Static Cache Settings
[INFORMATION]
****
[horizontal]
Default cache expiration:: 30 minutes.
Supported static file extensions:: `jpg`, `jpeg`, `gif`, `png`, `ico`, `bmp`, `tif`, `tiff`, `svg`, `svgz`, `swf`, `pict`, `cur`, `doc`, `docx`, `xlsx`, `ppt`, `pptx`, `pdf`, `woff`, `woff2`, `eot`, `otf`, `js`, `ejs`, `css`
Support for non-responsive origin servers:: No.
URI Specific Caching:: Per-URI features can be enabled, overriding the origin server values.
Manual Cache Purging:: Can be purged by {organization} SOC upon request. Purging can be limited to a specific URI.
****

==== Dynamic caching

* Dynamic caching offers a higher level of performance, allowing caching and optimization of dynamic content.
* In some cases, cached content can be delivered even if the origin servers are unresponsive.
* The {organization} platform caches all responses to requests made with HTTP `GET` and `HEAD` methods.
* To avoid caching dynamic pages that are rarely accessed, {organization} sensors cache dynamic pages only after they are requested *at least 3 times*.
* Subsequent requests are served from the cache until the cache expiration defined in the Cache-Control occurs (or about 30 minutes for responses where the expiration is not defined).

.Dynamic Cache Settings
[INFORMATION]
****
[horizontal]
Default cache time:: 30 minutes
Time-to-cache:: Can be configured by {organization} SOC upon request.
URL based caching:: Can be configured by {organization} SOC upon request
Supported file types:: Any dynamic resources
Support for non-responsive origin servers:: 500, 502, 503, and 504 response codes. Can be configured by {organization} SOC upon request.
Supported request methods:: GET, HEAD
URI Caching::  Per-URI features can be enabled, overriding the origin server values.
Manual Cache Purging::  Can be purged by {organization} SOC upon request. Purging can be limited to a specific URI.
****

NOTE: Dynamic caching is a billable feature and requires an add-on license.

'''

=== Managing rate limiting

The {organization} platform rate limiting is in the form of rules in the common rule set.
Rate limiting is primarily focused on count and time frame.
What causes a rule to trigger when based off count and time frame is limited only by what the rules can match within the requests.
For example, one rule is *10 404s in 10s*, where the rule assigns risk to an entity that receives more than 10 404 responses within 10 seconds.

As needed, the {organization} SOC team can make custom rate limiting rules tailored for your environment.
A typical use of this would be to assign risk to entities that fail logins at a login endpoint.
These rate limiting rules are very customizable, including the timings (number of requests over time).
These rules can be applied across the entire tenant, down to a site or group of sites, or to a single endpoint.
The match criteria also have a very wide range of options such as Response Code, Request Method, Source Country/ASN, and Arguments.

'''

=== Managing rules

{organization} rules can specify firewall behavior required for your business‚Äôs individual needs, such as restricting certain resources to company IP addresses or limiting the number of failed login attempts to an application developed in-house.

A {organization} _rule_ is a set of Boolean conditions that, when true, implement the rule‚Äôs defined action and risk level. {organization} rules can watch, temporarily block, permanently block, interrogate, or tarpit suspicious traffic. The action is implemented by the sensor.

You can add, modify, and delete rules, and view‚Äôs rule‚Äôs activity to determine its effectiveness.

To access rules in the {organization} user interface, navigate to menu:Settings[Rules*. You can also manage custom rules using the {organization} API /tx_api/v1/rules endpoint__.__

IMPORTANT: Rules can be complex. Creating or modifying a rule could have unintended consequences. You can request the {organization} SOC group to create rules or modify any rule in the {organization} platform to meet the specific needs and behavior of your environment.


==== Rule details

To view a rule‚Äôs details, navigate to menu:Settings[Rules] then click btn:[Edit Rule Details] for a specific rule.

Description:: Text that describes the intended behavior or logic a rule match is intended to indicate. This information is displayed in the {organization} user interface when your custom rule is matched.
Tag Name:: Text that identifies a rule when a description is long
Classification:: Describes the kind of attack or behavior it is meant to detect. See <<rule-classifications,Rule Classifications>> table.
State:: Assumed objective. Maps the intent to a stage on {organization} Web Application Kill Chain. <<rule-states,Rule States>> table.
Risk:: Assigned risk level (0 to 100) at which the entity triggers a rule. The higher the rule‚Äôs risk, the fewer hits it takes to block a given entity. The biggest factor in determining entity risk is the total risk assigned by rules they trigger, which you can see in <<rule-risks,Risk Assignment>> table.
Action:: Action for the sensor to perform. See the <<rule-actions,Rule Actions>> table.
Visual:: Tab that displays the rule in a graphical format.
JSON tab:: Tab that displays the rule in a JSON format.
Beta:: If selected, the platform *does not process matches* to rhe rule.

.Rule Classifications
[cols="30m,60",options="header",id="rule-classifications"]
|===
|Classification |Description

|Undefined
|Unknown attack type.

|SqlInjection
|SQL injection attack. Attempt to exploit input form or un-sanitized input vector to the SQL backend.

|XSS
|Cross Site Scripting. Attempt to execute unauthorized code in the user‚Äôs context.

|RFI
|Remote File Inclusion. Attempt to have the application server evaluate or include unauthorized 3rd party content or code.

|SessionHijacking
|Attempted unauthorized takeover or co-opting an existing authenticated session.

|DirTraversal
|Directory traversal. Attempt to have the application server evaluate or include unexpected and potentially sensitive content

|Evasion
|Attempt to evade detection of malicious commands or code with various encoding tricks.

|TrojanActivity
|Indications of known malicious software.

|InfoDisclosure
|Information disclosure. Attempt to inappropriately disclose sensitive information about a server, application, or other.

|ExecutableCode
|Indications of an attempt to upload or execute executable code in a malicious context.

|PasswordGuessing
|Attempted word list or online brute-force to gain access to known application accounts.

|PasswordSpraying
|Attempted use of known default, weak, or compromised passwords to gain unauthorized access.

|CredentialStuffing
|Attempted discovery or unauthorized use of compromised user credentials username and password.

|FormSpam
|Abuse user-generated content such as response forms, comments, and reviews for unauthorized promotional purposes.

|OSDetection
|Operating System detection. Attempt to fingerprint server operating system for use in targeting future attacks.

|ContentEnumeration
|Enumerate site pages or content for abusive or malicious purposes.

|PluginEnumeration
|Enumerate content-management-system plugins, software components, and more for use in targeting future attacks.

|UsernameEnumeration
|Attempt to collect authorized users for future malicious purposes.

|ResourceExhaustion
|Attempt to exhaust server CPU and memory resources to negatively impact legitimate services.

|TrafficFlood
|Attempt to exhaust server bandwidth resources to negatively impact legitimate services.

|HighVolume
|High request volume. Suspicious or maliciously high volume of requests, bandwidth used, or other volume with the intent to negatively impact legitimate service.

|ErrorRate
|Elevated error rate. Indication that an offending entity might be performing malicious actions as evidenced by an increase in HTTP errors returned by the server.

|KnownVulnerability
|Attempt to exploit a known vulnerability in the application.

|CSRF
|Cross Site Request Forgery. Attempt to abuse a user or user-agent context to perform unauthorized actions on behalf of logged-in user.

|EscalationOfPrivilege
|Attempt to gain unauthorized access or gain permissions otherwise not expected or permitted for a given user.

|WebShell
|Indicators of malicious code intended to aid in unauthorized access to a web application or server.

|BadBot
|Known malicious or undesirable web bots, spiders, scrapers, or other entities.

|CommandInjection
|Attempt to trigger server-side execution of unauthorized commands through a web form or application.

|CryptoMining
|Cryptocurrency mining. Attempt to use server resources for unauthorized cryptocurrency related activities.

|Toolkit
|Hacker toolkit. Indicators of known security or hacker toolkit attempting access to the web application.

|BotnetActivity
|Indicators of known botnet or infected hosts attempting access to the web application.

|BusinessLogicAbuse
|Abuse of custom business logic or application workflow to commit various fraudulent or unauthorized activity.

|LFI
|Local File Inclusion. Attempt to have the application server evaluate or include local, potentially sensitive, content.

|MaliciousInclude
|Attempt to introduce known malicious code for execution in user or user-agent context.

|SoftwareDetection
|Attempt to fingerprint application technology and frameworks for future malicious use.

|ProgrammaticAccess
|Indicators of programmatic or automated access attempts for the web application.

|CustomerRule
|Custom rules to enforce business logic which might not fit in another rule category.

|===

'''

.Rule States
[cols="30m,70",options="header",id="rule-states"]
|===
| State |Description

|Reconnaissance
|Basic data collection

|Scanning
|Scanning for content and known vulnerabilities

|Web Application Mapping
|Find possible weak points

|Brute Force Attack
|Gain unauthorized access

|Denial of Service
|Disrupt application availability

|Exploitation
|Exploit application weaknesses

|Malware Communication
|Consolidate position on a compromised server

|===

'''

.Rule Risk Assignments
[cols="30m,70",options="header",id="rule-risks"]
|===
|Range |Description
|[0-10] *(Low)*
|*Best used to track interesting, but not notably suspicious requests.* Rules with this risk level never result in a block unless combined with a higher risk rule.

|[11-90] *(Medium)*
|*Should be used for most rules.* Multiple matches are required before blocking an entity. This reduces the likelihood of blocking a benign entity (which sent a few odd-looking requests).

|[91-100] *(High)*
|*Indicates a known vulnerability or probable malicious threat.* A request triggering a risk 91+ rule quickly increases the entity‚Äôs risk score and results in a block.

|===

'''

.Rule Sensor Actions
[cols="30m,70",id="rule-actions", options="header"]
|===
|Action |Description

|Track
|Begin or continue tracking a risk score for the offending entity, based on the risk assigned to this rule and other factors. This is the default and recommended action for most custom rules.

|Block
|Immediately block the request and track a risk score for the offending entity. Blocking rules are best used to stop known malicious behavior, ‚Äúvirtually patch‚Äù known vulnerabilities, etc.

|Tarpit
|Limit the speed at which the offending entity receives responses and tracks a risk score for the entity. Tarpit actions are best used to discourage scanning or scraping behavior without immediately blocking the traffic.

|Interrogate
|Challenge an offending entity with a cookie and attempt to fingerprint the user-agent. Interrogation allows a custom rule to explicitly invoke anti-bot mitigations for an entity.

|===

'''

==== Rule format

A rule must define at least one *criteria*: a boolean expressions that consist of an *attribute* and a *supplied value*.

Some criteria have an operator to determine how the value is compared.
However, if there is *no operator available*, the criteria can still be met if that *attribute value* is *equal* to the *checked value*.

Criteria are contained within a *group*: a boolean expression derived from comparing the results of all those criteria. The group can have multiple nested levels to support complex conditions.

===== Rule Evaluation Operators

[horizontal]
or:: Rule is matched if any of the criteria are true.
and:: Rule is matched if all the criteria are true.
not:: Rule is matched if none of the criteria are true.

TIP: A `true` state is also known as a *match*.

When a rule is matched, a `classification`, `state`, and `risk level` is assigned to the threat.
The sensor also then performs the configured `action`.

The following figure shows the *Visual* tab with the *Group Type* operator set to *and*, and one criteria entry with *Header* as the attribute.
The `Header` attribute has two required variables: `direction` and `field`
The direction determines that headers in requests only are checked, and that the header name is `User-Agent`.
For this entry to be true, the header name must contain `Bad-Guy`.

image::common/rule-group-type.png[Rule Group Type,width=881,height=346]

===== Additional Operators

Some criteria attributes have additional operators available:

[horizontal]
contain(s):: Expression is true if the value includes the provided value.
equal(s):: Expression is true if the value is equal to the provided value.
Starts with:: Expression is true if the value begins with the provided value.
Regex:: Expression is true if the value equals the provided regular expression.
Group:: Allows you to add a group within the criteria.

==== Types of Criteria

There are three types of criteria:
* <<entity-criteria,Entity>>
* <<request-criteria,Request>>
* <<response-criteria,Response>>

.Entity Criteria
[cols="30m,10,60",options="header",id="entity-criteria"]
|===
|Attributes |Description |Example

|Source IP
|Checks if the entity‚Äôs IP address matches at least one of the provided list of IPv4 addresses or CIDR networks.
|127.0.0.1/24, 127.0.1.1, 127.54.3.64/26

|Countries
|Uses Internet geolocation to check if the entity‚Äôs IP address resolves to at least one of the provided countries. The criteria take a comma-separated list of two-letter country codes (ISO alpha2).
|PR,RU,UA

|===

.(Incoming) Request Criteria
[cols="30m,10,60",options="header",id="request-criteria"]
|===
|Attributes |Description |Example

|Hostname
|Checks if the Host header sent in a HTTP request matches the provided name.
|`example.com`

|URI
|Checks if the ‚Äúpath‚Äù portion of URI sent in HTTP request matches the provided path.
|`/wp-login.php`

|Arguments
|Checks if the ‚ÄúURL query‚Äù or form-encoded POST data sent in HTTP request matches the provided argument.
|`wp-submit=Log+In`

|Named Argument
|Checks if a specific ‚ÄúURL query‚Äù or form-encoded POST data key + value pair sent in HTTP request matches the provided argument. Requires an argument name.
|`Log+In`, `name:wp-submit`

|Method
|Checks if the HTTP method used in the request matches the selected method.
|`POST`

|Header
|Checks if a specific HTTP header value matches the provided header. The *direction* must be *Request* and the *field* must contain the header name.
|`Mozilla/5.0 (Chrome) direction:Request header-name:User-Agent`

|===

.Response Criteria
[cols="30m,10,60",options="header", id="response-criteria"]
|===
|Attributes |Description |Example

|Response Code
|Check the HTTP response code/status code returned by the application.
|`401`

|Header
|Check if a specific HTTP header value matches. The *direction* must be *Response* and the *field* must contain the header name.
|`JSESSIONID= direction:Response header-name:Set-Cookie`

|===

==== Rule matching

For a rule to be matched, the condition set by the operator of the group must be true.
For example, some of the criteria are matched while others are not.
If the group operator is set to *or*, the rule is matched since at least one criterion is matched.
If the operator is *and*, the rule would not be matched.

==== Rule activity

The {organization} user interface displays how often a rule is matched and its action implemented.
To view a rule‚Äôs activity, navigate to menu:Settings[Rules > View Activity] for a specific rule.
This page is also accessible from other pages by clicking a rule name in the *Rules* column.

NOTE: Depending on your configuration, you might need the {organization} SOC to enable the permission for you to access the rule activity.

image::common/Rule-Activity-no-nav.png[Rule Activity,width=1024,height=766]

You can use the data to determine the effectiveness of the rule and if a change is needed, such as:

* Does a threat match too many rules?
* Does the rule catch the expected threats?

The *Rule ID* tile provides some of the details of the rule, which is also provided in the Rule Details page.

The *Matched Threats* tile shows the total number of threats that matched the rule in the selected time frame.

===== Matched Threats Table

The *Matched Threats* table provides data for each threat that matched the rule and lists any other rules that were matched by the threat.

Clicking a rule name in the *Rules* column displays that rule‚Äôs activity page.

Hovering over a rule in the *Rules* column also highlights all instances of the same rule in the other rows.

The *Match Events* column shows the number of times traffic matched a rule within the selected time range and its change over time.
A significant value could indicate a security problem.

You can click *Activity* to view the *Activity* table, which lists each attack and the time it occurred.

TIP: For detailed information about the other data in the table, see the xref:analyst_guide.adoc[{organization} Managed API and Application Protection Platform Analyst Guide].

'''

=== Configuring Single Sign On (SSO)

You can manage SSO configuration directly using the {organization} API.
Once SSO has been configured for a {organization} tenant or channel, your users can sign in using your SSO identity provider, such as Okta or Azure Active Directory B2C, rather than logging in to the {organization} web application with a username and password.

==== Prerequisites

- [ ] *SAML2 IDP metadata reference URL* from your SSO provider (where the most up-to-date metadata file can be found.) Consult your IDP documentation.
- [ ] Users must have accounts in *both* the *IDP* and *{organization} platform*
- [ ] User‚Äôs *email address* in the IDP *must match* that which is associated with their {organization} username.
- [ ] An  link:#generating-and-revoking-api-keys[API key] with *tenant or channel administrator* permissions.
- [ ] The *name* and *UUID* of your tenant or channel

TIP: Use the `Customers:list` command to retrieve the name and UUID of the tenant.

NOTE: If you do not have access to your IDP metadata URL, you can alternatively provide a complete IDP metadata file. Contact {organization} support if you want to provide an IDP metadata file instead of an IDP metadata URL.

.IDP Metadata URLs
====
* *Okta*: link:https://threat-x.oktapreview.com/app/exk8lh09bhSIfhupl0h7/sso/saml/metadata[]
* *Azure AD B2C*: https://login.microsoftonline.com/daad3805-fde6-4334-817f-82c723533123/federationmetadata/2007-06/federationmetadata.xml[]
====

===== Additional prerequisites for Channel SSO

If you are configuring your *SP Metadata URL*:

* Audience restriction setting (also called ‚ÄúEntity ID‚Äù) in the IDP must be set to the path: `https://x.threatx.io/sign-in`
* *IDP metadata* must provide the _NameID_ in the format: `urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress`

NOTE: We use the email address of the user to locate users within our database

If you are configuring your *ACS URL*:

* When configuring the IDP, *the Assertion Consumer Service URL (ACS)* of our *Service Provider (SP)* is: `https://x.threatx.io/auth/v2/channels/\{your_threatx_channel_uuid/acs`
* For IDPs that support Service Provider metadata, the metadata URL of our SP is: `https://x.threatx.io/auth/v2/channels/\{your_threatx_channel_uuid/metadata`

==== Configuring SSO access

Use the following steps to configure SSO access for your {organization} tenant and channel partners:

. *Log into the API.* Authenticate to the API using the Login command.
. *Gather the tenant or channel data* you need using the `Customers:list` or `Channels:list` command.
* You need to copy the Customer or Channel Representation information response *exactly* and paste it into the body of the `Customers:update` or `Channels:updat` command with the UUID field omitted.
. *Assemble your tenant update API request.*
. Supply your Customer or Channel Representation information to the `Customers:update`  or `Channels:update` command described in step 2. (See the examples below.)
. Set the value of ‚Äússo‚Äù to an object  and define these attributes:
* ‚Äúenabled‚Äù (`true`),
* ‚Äúrequired‚Äù (`false`)
* `saml_metadata_url`
. *Submit the tenant or channel update API request.* If it succeeds, you should see Customer Update Response or Channel Update Response.
. Test the new configuration by using a web browser to navigate to:
.. link:https://x.threatx.io/auth/v2/customers/<name>/saml[]
.. link:https://x.threatx.io/auth/v2/channels/<name>/saml[]
. You should be redirected to your SSO Identity Provider to confirm you want to authorize {organization} Dashboard to act on your behalf.
. Follow the prompts in your SSO Identity Provider.
. You should be then redirected to the {organization} Dashboard and authorized to access the system on behalf of your configured user account.
. Single-Sign On access is now configured for your tenant.

TIP: _(optional)_ You can now update your tenant configuration again using ‚Äúrequired: true‚Äù to force all your users to use SSO to access the {organization} Dashboard. This option prevents users from accessing the {organization} Dashboard directly using the username/password authentication.

==== API commands and usage

===== Login

****
The *`login`* command uses an _API key_ to return a _temporary access token_ that authenticates your session.
****

The *api_key*, created within the {organization} user interface ( menu:Settings[API Keys] ), is used within the request for the `api_token` parameter. The response then provides a unique and temporary `access_token` string to be used in further endpoint commands.

.Login Command Object
[cols="75,25",options="header",width="60%",id="login-command-object-table"]
|===
|Parameters |Type
|`‚Äúcommand‚Äù: ‚Äúlogin‚Äù`
|String

|`‚Äúapi_token‚Äù: ‚Äù_<api_key>_‚Äù`
|String
|===


.Login Command Usage
====
.Request
[,console,subs=+macros]
----
$ curl https://api.threatx.io/tx_api/v1/login \
  --header 'Content-Type: application/json' \
  --data @- <<EOF
{
    "command": "login",
    "api_token": "<pass:quotes[*_api_key_*]>"
}
EOF
----


.Response
[source,json,subs=+macros]
----
{
"Ok": {
    "status": true,
    "token": "<pass:quotes[*_access_token_*]>"
  }
}
----

====

'''

===== List Customers

****
The *`list`* command returns the details of all tenants authorized for the current API access token.
****

.Command Object
[cols="75,25",options="header",width="50%"]
|===
|Parameters |Type

|`‚Äúcommand‚Äù: ‚Äúlist‚Äù`
|String

|`‚Äútoken‚Äù: ‚Äú<access_token>‚Äù`
|String
|===


.List Command Usage
====
.Request
[source,console,subs=+macros]
----
$ curl https://api.threatx.io/tx_api/v1/customers \
  --header 'Content-Type: application/json' \
   --data @- <<EOF
{
  "command": "list",
  "token": "pass:quotes[*<_access_token_>*]"
}
EOF
----

Replace `_<access_token>_` with your access token from the last command.

.Response
[source,json,subs=+macros]
----
{
"Ok": [
   {
   "name": "testco",
   "contact_email": "alice@testco.com",
   "description": "Tesco tenant",
   "active": true,
   "autoblock_threshold": 70,
   "autoblock_timeout": 3600,
   "block_embargo": true,
   "ssl_ciphers": null,
   "notify_threshold": 100,
   "sso": null,
   "allow_super_admin_users": true,
   "allow_channel_admin_users": true,
   "tenant_admin_default": null,
   "uuid": "<pass:quotes[*_tenant_uuid_*]>"
   }
  ]
}
----
====

'''''

===== Update Customer

****
The *`update`* command updates a specified tenant.
****

The SSO object is used to configure the SSO parameters. All other parameters to the customer object should not be modified when configuring SSO.

.Command Object
[cols="70m,30",options="header",width="50%"]
|===
|Parameters |Type

|‚Äúcommand‚Äù: ‚Äúupdate‚Äù
|String

|‚Äútoken‚Äù: ‚Äú_<access_token>_‚Äù
|String

|‚Äúname‚Äù: ‚Äú_<tenant_name>_‚Äù
|String

|‚Äúcustomer‚Äù: {}
|CustomerObject
|===


.Customer Object
[cols="75m,25",options="header",width="50%"]
|===
|Parameters |Type

|‚Äúname‚Äù: ‚Äú_<tenant_name>_‚Äù
|String

|‚Äúcontact_email‚Äù: ‚Äú_<email_address>_‚Äù
|String

|‚Äúdescription‚Äù: ‚Äú_<key_description>_‚Äù
|String

|‚Äúactive‚Äù: true / false
|Boolean

|‚Äúautoblock_threshold‚Äù: _<entity_risk>_
|Integer

|‚Äúautoblock_timeout‚Äù: _<timeout_seconds>_
|Integer

|‚Äússo‚Äù: {}
|SSO Object
|===


.SSO  Object
[cols="30m,10,60",options="header"]
|===
|Parameters |Type |Description

|enabled
|Boolean
|When true, users belonging to the tenant are allowed to sign in to the {organization} user interface using SSO.

|required
|Boolean
|When true, users are required to use SSO to sign in to the {organization} user interface.

|saml_metadata_url: ‚Äú_<saml_url>_‚Äù
|String
|IDP metadata URL or file. See the Prerequisites.

|===

.Update Command Usage
====
.Request
[,console,subs=+macros]
----
$ curl https://api.threatx.io/tx_api/v1/customers \
  --header 'Content-Type:  application/json' \
   --data @- <<EOF
{
     "command": "update",
     "token": "<pass:quotes[*_login_token_*]>",
     "name": "testco",
     "customer": {
         "name": "testco",
         "contact_email": "alice@testco.com",
         "description": "Testco tenant",
         "active": true,
         "autoblock_threshold": 70,
         "autoblock_timeout": 3600,
         "block_embargo": true,
         "ssl_ciphers": null,
         "notify_threshold": 100,
         "allow_super_admin_users": true,
         "allow_channel_admin_users": true,
         "tenant_admin_default": null,
         "sso": {
             "enabled": true,
             "required": false,
             "saml_metadata_url": "https://login.microsoftonline.com/daad3805-fde6-4334-817f-82c723533123/federationmetadata/2007-06/federationmetadata.xml"
          }
    }
}
EOF
----

.Response
[,json]
----
{ "Ok": "testco updated." }
----
====

'''''

===== List Channels

****
The *`list`* command of the *`channels`*  endpoint returns the details of all channels authorized for the current API access token.
****

.Command Object
[cols="70m,30",options="header",width="50%"]
|===
|Parameters |Type

|‚Äúcommand‚Äù: ‚Äúlist‚Äù
|String

|‚Äútoken‚Äù: ‚Äú_<access_token>_‚Äù
|String
|===

.List Command Usage
====
.Request
[,console,subs=+macros]
----
$ curl https://api.threatx.io/tx_api/v1/channels \
  -H 'Content-Type: application/json' \
  --data @- <<EOF
{
    "command": "list",
    "token":" "<pass:quotes[*_access_token_*]>"
}
EOF
----

.Response
[source,json"]
----
{
  "Ok": [
    {
      "name": "test_channel",
       "require_totp_setup": null,
       "uuid": "81815E73-ABB9-4533-977B-93964B8AAB73",
       "sso": null
     }
  ]
}
----
====

'''''

===== Update Channels

The `update` command updates a specified channel.

.Command Object
[cols="70m,30",options="headers",width="50%"]
|===

|Parameters |Type

|command
|String

| token
|String

|channel
|<<channel-object-attributes,Channel Object>>

|===


[[channel-object-attributes]]
.Channel Object
[cols="70m,30",options="headers",width="50%"]
|===
| Parameter | Type

|name
|String

|sso
|<<sso-object-attributes,SSO Object>>

|===


[[sso-object-attributes]]
.SSO Object Attributes
[cols="30m,10,60",options="header",width="50%"]
|===
| Name | Type | Description

| enabled
| Boolean
| When true, users belonging to the channel are allowed to sign in to the {organization} user interface using SSO.

| required
| Boolean
| When true, users in the channel are required to use SSO to sign in to the {organization} user interface.

| saml_metadata_url
| String
| IDP metadata URL or file. See the Prerequisites.
|===


.Update Command Usage
====
.Request
[,console,subs=+macros]
----
$ curl https://api.threatx.io/tx_api/v1/channels \
  --header 'Content-Type: application/json' \
  --data @- <<EOF
{
    "command": "update",
     "token": "<pass:quotes[*_login_token_*]>",
     "channel": {
     "name": "test_channel",
     "sso": {
        "enabled": true,
        "required": false,
        "saml_metadata_url": "https://login.microsoftonline.com/daad3805-fde6-4334-817f-82c723533123/federationmetadata/2007-06/federationmetadata.xml"
       }
     }
}
EOF
----

.Response
[,json]
----
{"Ok": "Channel: test_channel updated."}
----
====

'''

=== Configuring mutual TLS (mTLS) configuration

This section details the configuration and setup of mutual TLS (mTLS) for secure communication between various components within our system. mTLS establishes a mutual authentication process between clients and servers, ensuring a robust and authenticated connection. You can enable mTLS in both downstream and upstream configurations.

In Transport Layer Security (TLS), the traditional setup involves the server authenticating itself to the client. However, mTLS enhances security by enabling both the client and server to authenticate each other during the communication process.

==== *Configuring downstream mTLS*

Downstream mTLS involves the WAF sensor serving as the server, authenticating incoming client connections. This setup is crucial for securing communication between end-user applications (clients) and the WAF.

Make sure your environment meets the following requirements for downstream mTLS:

* Site must be configured for TLS (HTTPS) via the SSL/TLS Enabled option on the Site Details page.
* Availability of the CA certificate used to sign client certificates, which utilizes as Downstream mTLS Credentials in the site configuration. This certificate must be in PEM format.
* Clients must be configured to send their certificates during the TLS handshake.

Configuration steps:

. Access the Site Details page through menu::Settings[Sites > Edit Site (for the relevant site)]
. In the SSL/TLS Configuration section, enable Downstream mTLS by checking the designated checkbox.
. Populate the Downstream mTLS Credentials field with the CA certificates used for validating client certificates.

image::common/mTLS1.png[mTLS,width=948,height=571]


==== Configuring Upstream mTLS

Upstream mTLS involves the WAF sensor acting as the client, authenticating itself to the origin server. This setup ensures secure communication from the WAF to the origin server.

Make sure your environment meets the following requirements for upstream mTLS:

* Site must be TLS-enabled via the SSL/TLS Enabled option in the Site Details page.
* Ensure that the TLS connection termination does not occur at the WAF sensor; the *SSL/TLS Terminate Only* checkbox should remain unchecked. The origin server should be configured for HTTPS.
* Availability of both the client certificate and private key in PEM format, used as the Upstream mTLS Credentials in the site configuration.
* The origin server should be configured to request client certificates during the TLS handshake.

Configuration Steps:

. Access the Site Details page through menu:Settings[Site], selecting btn:[Edit Site] for the relevant site.
. Within the SSL/TLS Configuration section, enable Upstream mTLS by checking the designated checkbox.
. Populate the Upstream mTLS Credentials field with both the client certificate and private key.

image::common/mTLS2.png[mTLS,width=948,height=571]

==== Notes

* The simultaneous configuration of both Downstream and Upstream mTLS is possible and can be individually managed within the Site Details page.
* To expose the mTLS settings within the Site Details page, a tenant needs to enable the feature *flag site-config-mtls*.

==== Conclusion

By configuring mutual TLS in both downstream and upstream modes, you establish a secure and authenticated communication channel between clients, the WAF, and the origin server, ensuring robust protection and trust across the implementation.

'''

=== Testing for Vulnerabilities

The {organization} four-stage blocking strategy is designed to reduce false positives while preventing malicious behavior from reaching your sites. When Request-Based blocking is enabled, the sensor blocks any standalone malicious request. When Risk-Based blocking is enabled, the sensor issues a series of timed block periods to any entity that exhibits persistent suspicious or malicious behavior, leading to a permanent blacklisting if the behavior continues. During a 30-minute Block period or while an entity is blacklisted, all requests from that entity are blocked from reaching the site.

When testing for vulnerabilities against your internal applications, the IP addresses of your penetration testers should be added to the whitelist before testing, and removed after testing is complete.

When testing for vulnerabilities in the sensor, the IP addresses of your penetration testers should not be added to the whitelist.

To add an IP address to the whitelist:

. Navigate to menu:Settings[iWAF].
. In the iWAF Settings page, click the btn:[Whitelisted IP addresses] tab.
. Click the btn:[Add Entry] button.
. In the *Add Whitelist Entry screen*, enter the IP address.
. Enter the reason for adding the IP address.
. Set the *Expiration*. Typically, you choose *Never* but you do need to remove the address from the list when done testing.
. Click btn:[Submit].

When done testing, remove the address by opening the *Whitelisted IP addresses* tab and click the *Remove* button in the entity‚Äôs row.

.Recommended Tools and Methodologies
****
Scanners:: Scanners, such as https://www.zaproxy.org/[ZAP] and https://portswigger.net/burp/[Burp], can be a useful tool for testing the {organization} Request and Risk-based blocking capabilities. However, they are likely to be blocked quickly and sent to the blacklist.
Leverage multiple IP addresses:: When attacking the {organization} sensor with a single IP address, that IP address accumulates risk and is delivered a series of Risk and Request-Based blocks before being placed on the blacklist. The entity associated with that IP address can be removed from the blacklist, but the associated Risk Level from that entity does not reset to ‚Äú0‚Äù upon removal. An entity‚Äôs Risk Level can be reduced over time by demonstrating a reduction in suspicious behavior or malicious attack attempts. Try leveraging several IP addresses or ranges when pen testing the {organization} sensor.
****

You can see when the IP address is blocked from the {organization} user interface. In the following screenshot, the Gray requests were blocked from reaching the application. The White request was allowed through as it did not contain a standalone, viable attack or high-risk behavior.

image::common/Pen-test-screenshot.png[Penetration Test,width=1024,height=836]

'''

=== Troubleshooting sensor issues

When you have an issue with sensors, contact the {organization} SOC at support@threatx.com with a description of your issue.

Depending on the nature of the issue, the {organization} SOC might request one of the following files.

* HTTP Archive format file (`.har`). HAR files contain sensitive data, including content of the pages you downloaded while recording as including your cookies. The {organization} SOC can use it to troubleshoot connectivity or other issues with the sensor.
* PCAP (packet capture) file. The file contains captured network packets. The SOC requests a `.pcap` file only if you host your own sensors.

==== How to generate a HAR file

How you generate a HAR file depends on the web browser you use.

===== Generating a HAR file in Chrome

. Open Google Chrome and navigate to the page where the issue is occurring.
. Look for the Vertical ellipsis button and select menu:More Tools[Developer Tools > Network]
. Look for a Record button in the upper left corner of the tab and make sure it is red. If it is grey, click it once to start recording.
. Check the *Preserve log* box
. Click btn:[Clear] to clear out any existing logs from the Network tab.
. Reproduce the issue you are experiencing.
. Once you have reproduced the issue, select menu:Right Click[Save as HAR with Content]
. Upload the HAR file as an attachment to your {organization} support ticket for further.

===== Generating a HAR file in Mozilla Firefox

. Open Mozilla Firefox and navigate to the page where the issue is occurring.
. Select menu:Mozilla Firefox Menu[Web Developer > Network]
. The recording automatically starts when you begin performing actions in the browser.
. Once you have reproduced the issue and you see that all the actions have been generated in the Developer Network Panel (should just take a few seconds), menu:Right Click[File > Save all as Har]
. Upload the HAR file as an attachment to your {organization} support ticket for further analysis.

===== Generating a HAR file in Internet Explorer

. Open Internet Explorer and go to the page where the issue is occurring.
. Press kbd:[F12] on your keyboard to open developer tools. Then select btn:[Network]
. Reproduce the issue that you were experiencing while the network requests are being recorded.
. Once done, click btn:[Save]  and give the file a `.har` extension.
. Upload the HAR file as an attachment to your {organization} support ticket for further analysis.

===== Generating a HAR file in Safari

. Before generating the HAR file, make sure you can see the *Develop* menu in Safari. If it is not there, follow the instructions in link:https://support.apple.com/en-ie/guide/safari/use-the-developer-tools-in-the-develop-menu-sfri20948/mac[Use the developer tools in the Develop menu in Safari on Mac].
. Open menu:Develop[Show Web Inspector > Network > Export] and save the `.har` file.
. Upload the HAR file as an attachment to your {organization} support ticket for further analysis.

Edge natively produces HAR files. For more instructions, see the instructions from the https://docs.microsoft.com/en-us/microsoft-edge/devtools-guide/network[Microsoft website]. To generate a HAR file in Edge:

. Open the *Network* tool in F12 developer tools.
. Reproduce the issue.
. Export captured traffic as a HAR (CTRL + S).
. Upload the HAR file as an attachment to your {organization} support ticket for further analysis.

==== How to generate a PCAP file

The PCAP file is relevant only if you host your own sensors.

To generate a PCAP file that the {organization} SOC can analyze for troubleshooting connectivity or other issues with the WAF sensor, follow these instructions:

. Use SSH to connect into the docker host system.
. Use the following command to display the name of the desired container: +

[,console,subs=+macros]
----
# Enter the WAF
$ docker ps
$ docker exec -it pass:quotes[*<_container_id_>*] /bin/bash

# Install tcpdump
$ apt-get update && apt-get install -y tcpdump

# Capture traffic
$ tcpdump -i eth0 \
    -s 0 port not 22 \
    -w /tmp/upload_to_threatx.pcap

# Leave the container and retrieve the file
$ docker cp \
  pass:quotes[*<_container_id_>*]:/tmp/upload_to_threatx.pcap \
  upload_to_threatx.pcap
----

Upload the PCAP file to a {organization} support ticket for further analysis.



